<?php

   class FbusersController extends AppController {

	  var $uses = array('Fbuser', 'Like', 'Photo');
	  var $components = array('RequestHandler');
	  var $scaffold;

	  function beforeFilter() {
		 parent::beforeFilter();
		 if($this->user == 0 && $this->request->params['action'] != 'login'){
			$this->redirect(array('controller' => 'pages', 'action' => 'login'));
		 }
		 /* If it is ajax request don't load template. */
		 if($this->RequestHandler->isAjax()){
			$this->layout=null;
		 }
	  }

	  /**
	  * view logged user information.
	  */
	  function view($id = null) {
		 if($id != null) {
			$this->Fbuser->unbindModel(array('hasMany' => array('Like', 'Photo')));
			$data = $this->Fbuser->findById($id);
			// All photos associated to theyr like count
			$userid = $this->user;
			$photos = $this->Photo->query("SELECT Photo.id, Photo.name, Photo.source, Photo.link, Photo.hr, Photo.fbuser_id, Photo.fbuser_comment, (SELECT count(*) FROM likes WHERE likes.photo_id = Photo.id GROUP BY Photo.id) AS count, (SELECT count(*) FROM likes WHERE likes.photo_id = Photo.id AND likes.fbuser_id = $userid) AS liked FROM photos Photo WHERE Photo.fbuser_id = $id AND Photo.deleted = '0'");
			$this->set('user_data', $data['Fbuser']);
			$this->set('user_photos', $photos);
		 }
	  }

	  /* Facebook Login Methods. */

	  /**
	  * user facebook login.
	  */
	  function login() {
		 $this->autoRender = false;
		 $params = array(
			'scope' => 'user_photos, friends_photos, user_photo_video_tags, friends_photo_video_tags, friends_about_me',
			'redirect_uri' => 'http://localhost/twohotgirls/fbusers/callback/'
		 );
		 $this->redirect($this->facebook->getLoginUrl($params));
	  }

	  /**
	  * user facebook logout.
	  */
	  function logout() {
		 $this->autoRender = false;
		 $this->facebook->destroySession();
		 $params = array( 'next' => 'http://localhost/twohotgirls/photos/' );		
		 $this->redirect($this->facebook->getLogoutUrl($params));
	  }

	  /**
	  * facebook login callback.
	  * stores the user in the database if not already.
	  */
	  function callback() {
		 $this->autoRender = false;	
		 $this->facebook->getAccessToken();

		 $newUser = $this->Fbuser->create();
		 $data = $this->facebook->api('/me');
		 $newUser['Fbuser']['id'] = $data['id'];
		 $newUser['Fbuser']['name'] = $data['name'];
		 //$newUser['Fbuser']['picture'] = 'https://graph.facebook.com/'.$data['username'].'/picture';
		 $this->Fbuser->save($newUser);

		 $this->redirect(array('controller' => 'photos', 'action' => 'index'));
	  }
   }
?>
