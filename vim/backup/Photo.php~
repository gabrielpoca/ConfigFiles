<?php

   class Photo extends AppModel {
	  var $belongsTo = 'Fbuser';
	  var $hasMany = array('Like', 'Comment', 'Hot' => array('className' => 'Mash', 'foreignKey' => 'hot_id'), 'NotHot' => array('className' => 'Mash', 'foreignKey' => 'nothot_id'));

	  function paginate($conditions, $fields, $order, $limit, $page = 1, $recursive = null, $extra = array()) {
		 // get user id
		 $userid = $conditions['fbuser_id'];
		 // set order type
		 if(empty($order)) {
			$order = $extra['sort']." ".$extra['direction'];
		 } else {
			$order = key($order)." ".$order[key($order)];
		 }
		 // limit
		 if($page == 1) {
			$first = 0;
			$last = $limit;
		 } else {
			$first = ($page - 1)*$limit +1;
			$last = $limit*$page;
		 }
		 echo "SELECT Photo.id, Photo.name, Photo.source, Photo.link, Photo.created, Photo.hr, Fbuser.id, Fbuser.name, Photo.fbuser_comment, (SELECT count(*) FROM likes WHERE likes.photo_id = Photo.id) AS count, (SELECT count(*) FROM likes WHERE likes.photo_id = Photo.id AND likes.fbuser_id = $userid) AS liked FROM photos Photo, fbusers Fbuser WHERE Photo.fbuser_id = Fbuser.id AND Photo.deleted = '0' ORDER BY $order LIMIT $first, $last";
		 return $this->query("SELECT Photo.id, Photo.name, Photo.source, Photo.link, Photo.created, Photo.hr, Fbuser.id, Fbuser.name, Photo.fbuser_comment, (SELECT count(*) FROM likes WHERE likes.photo_id = Photo.id) AS count, (SELECT count(*) FROM likes WHERE likes.photo_id = Photo.id AND likes.fbuser_id = $userid) AS liked FROM photos Photo, fbusers Fbuser WHERE Photo.fbuser_id = Fbuser.id AND Photo.deleted = '0' ORDER BY $order LIMIT $first, $last");	
	  }

	  function paginateCount($conditions = null, $recursive = 0, $extra = array()) {
		 $res = $this->query("SELECT count(*) as COUNT FROM photos Photo WHERE Photo.deleted = '0'");
		 return $res[0][0]['COUNT'];
	  }
   }
?>
